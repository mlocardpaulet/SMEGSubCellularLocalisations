---
title: "Proteome analysis SMEG"
author: "Marie Locard-Paulet"
date: '`r date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r}
require(ggplot2)
require(corrplot)
require(gplots)
require(knitr)
```

Input: "RAW/Quantified proteins 290917.txt"
I have replaced the "#", "'" and tab in the excel file (Proline export) before saving in tab-delimited format.

**There are rows with no values in the abundance. Why?**

```{r}
input <- read.table("RAW/Quantified proteins 290917.txt", header = T, sep = "\t")
mapping <- read.table("RAW/Quantified proteins 290917_Mapping.txt", header = T, sep = "\t")
mapping$Label <- paste0(mapping$cellular.compartment, "-", mapping$biological.replicate, "-", mapping$technical.replicate)
```

```{r}
mat <- input[,c(2,which(grepl("abundance", names(input))))]
mat <- mat[,which(!grepl("raw_", names(mat)))]
na <- mat[,1]
mat <- as.matrix(mat[,2:ncol(mat)])
row.names(mat) <- na
colnames(mat) <- sub("abundance_Laura.", "", colnames(mat))
```

Remove the abundance values when no "psm_count":
```{r, eval=T}
# matrix with the number of ms/ms per prot per sample:
matpsm <- input[,c(2,which(grepl("psm_count", names(input))))]
matpsm <- as.matrix(matpsm[,2:ncol(matpsm)])
# Remove abundance values for cells with psm count == 0 or NA:

hist(log(mat), main = "Log intensities, in red the ones removed")
hist(log(mat[matpsm==0 | is.na(matpsm)]), add = T, col = "red")
l <- length(mat[matpsm==0 | is.na(matpsm)])
mat[matpsm==0 | is.na(matpsm)] <- NA
```

We removed `r l` abundance values with NAs or 0 psm_count.


```{r}
image(log(mat))
```

Pairwise plots:
```{r, eval = F}
pairs(log(mat[,1:16]), pch = ".", main = "plasma membrane")
pairs(log(mat[,17:32]), pch = ".", main = "secretome")
pairs(log(mat[,33:48]), pch = ".", main = "mycomembrane")
pairs(log(mat[,49:64]), pch = ".", main = "cytoplasm")
```

```{r}
M <- cor(log(mat[complete.cases(mat),]))
corrplot(M, method="color")
par(mar = c(8,2,4,1))
boxplot(log(mat), las = 2, cex = 0.5, main = "log-transformed abundance across runs")

heatmap.2(log(mat[complete.cases(mat),]), trace = "none", scale = "column")

pca <- prcomp(log(mat[complete.cases(mat),]), center = F, scale = F)

tab <- summary(pca)
kable(tab$importance[,1:3])


gtab <- pca$rotation
gtab <- as.data.frame(gtab)
gtab$Condition <- mapping$cellular.compartment[match(sub("abundance_Laura.", "", colnames(mat)), mapping$Sample.name)]
gtab$Replicate <- mapping$biological.replicate[match(sub("abundance_Laura.", "", colnames(mat)), mapping$Sample.name)]
gtab$Replicate <- as.character(gtab$Replicate)

ggplot(gtab, aes(x = PC1, y = PC2, col = Condition, label = Replicate, shape = Replicate)) + theme_bw() + geom_point()
```

# Identities of protein detected in the cell compartments

Proteins are detected in a compartment if these have an abundance in a minimum of 2 runs.

Venn diagrams:
```{r}
# Make list with one matrix per compartment:
l <- lapply(sort(unique(as.character(mapping$cellular.compartment[match(colnames(mat), mapping$Sample.name)]))), function(x) mat[,as.character(mapping$cellular.compartment[match(colnames(mat), mapping$Sample.name)])==x])
names(l) <- sort(unique(as.character(mapping$cellular.compartment[match(colnames(mat), mapping$Sample.name)])))
l2 <- l
for (i in seq_along(l)) {
  temp <- l2[[i]] 
  temp[temp>0 & !is.na(temp)] <- 1
  l2[[i]] <- temp
}
lsum <- lapply(l2, rowSums, na.rm = T)

lprot <- lapply(1:length(l), function(x) rownames(l[[x]])[lsum[[x]]>=16])
kable(data.frame("Cellular compartment" = names(l), "Number of proteins detected" = sapply(lprot, length)))
#venn(lprot)
venn(list("cytoplasm" = lprot[[1]], "mycomembrane" = lprot[[2]], "plasma membrane" = lprot[[3]], "secretome" = lprot[[4]]))

int <- intersect(lprot[[1]], lprot[[2]])
int <- intersect(lprot[[3]], int)
int <- intersect(lprot[[4]], int)

colvec <- c("darkgreen", "yellow", "red")

pal <- colorRampPalette(colvec)

boxplot(log10(mat[rownames(mat) %in% int,]), las = 2, main = "Proteins common to the 4 compartments")
heatmap.2(log10(mat[rownames(mat) %in% int,]), trace = "none", col = pal(300))

secprot <- setdiff(lprot[[4]], lprot[[1]])
secprot <- setdiff(secprot, lprot[[2]])
secprot <- setdiff(secprot, lprot[[3]])
write.table(input$description[match(secprot, input$accession)], "secretome.txt", sep = "\t")
secprot <- setdiff(lprot[[2]], lprot[[1]])
secprot <- setdiff(secprot, lprot[[3]])
secprot <- setdiff(secprot, lprot[[4]])
write.table(input$description[match(secprot, input$accession)], "mycomembrane.txt", sep = "\t")
secprot <- setdiff(lprot[[3]], lprot[[1]])
secprot <- setdiff(secprot, lprot[[2]])
secprot <- setdiff(secprot, lprot[[4]])
write.table(input$description[match(secprot, input$accession)], "plasmaMembrane.txt", sep = "\t")
secprot <- setdiff(lprot[[1]], lprot[[3]])
secprot <- setdiff(secprot, lprot[[2]])
secprot <- setdiff(secprot, lprot[[4]])
write.table(input$description[match(secprot, input$accession)], "cytoplasm.txt", sep = "\t")
```

